#!/usr/bin/env bash

# Exit immediately if a command exits with non-zero status
set -e

# Array of PHP versions to test
PHP_VERSIONS=("8.2" "8.1" "8.0" "7.4")

test_version() {
  local VERSION="$1"
  echo "üöÄ Testing PHP $VERSION..."

  # Start the app container
  VERSION="$VERSION" docker compose -f docker-compose.test.yml up -d app

  # Allow services to initialize
  echo "‚è≥ Waiting for services to start..."
  sleep 2

  # Run the system under test
  echo "üß™ Running tests for PHP $VERSION..."
  VERSION="$VERSION" docker compose -f docker-compose.test.yml run --rm sut

  # Optional: Clean up after each test
  VERSION="$VERSION" docker compose -f docker-compose.test.yml down

  echo "‚úÖ Completed testing PHP $VERSION"
  echo "-----------------------------------"
}

# Main execution
echo "üîç Starting test suite for all PHP versions"

for VERSION in "${PHP_VERSIONS[@]}"; do
  test_version "$VERSION"
done

echo "‚ú® All tests completed!"
